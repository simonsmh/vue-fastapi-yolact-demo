#One line add to nginx.conf
#include /var/www/simonsmh/nginxproxy/*;
#enable ssl in all secon domain server require letsencrypt installed
#service nginx stop && certbot certonly --standalone --email simonsmh@gmail.com -d simonsmh.cc -d app.simonsmh.cc -d www.simonsmh.cc -d blog.simonsmh.cc -d tieba.simonsmh.cc -d openwrt.simonsmh.cc -d dist.simonsmh.cc -d bt.simonsmh.cc -d pan.simonsmh.cc -d url.simonsmh.cc -d ipv6.simonsmh.cc -d ports.simonsmh.cc -d wiki.simonsmh.cc && service nginx restart
#expire on 2016-10-18
#add "--server https://acme-staging.api.letsencrypt.org/directory" to avoid rate limit problem.
#SSL Settings
ssl_certificate /etc/letsencrypt/live/simonsmh.cc/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/simonsmh.cc/privkey.pem;
ssl_session_timeout 10m;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
ssl_prefer_server_ciphers on;
ssl_ciphers ECDHE-RSA-AES256-SHA384:AES256-SHA256:RC4:HIGH:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!AESGCM;
ssl_session_cache shared:SSL:10m;
add_header Strict-Transport-Security "max-age=3153600; includeSubdomains; preload";
server {
listen 80;
listen [::]:80;
server_name simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 80;
listen [::]:80;
server_name ipv6.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 80;
listen [::]:80;
server_name app.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 80;
listen [::]:80;
server_name tieba.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 80;
listen [::]:80;
server_name bt.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 80;
listen [::]:80;
server_name pan.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 80;
listen [::]:80;
server_name url.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 443 ssl;
listen [::]:443 ssl;
server_name url.simonsmh.cc;
return 301 $args;
}
#defalt
server {
listen 443 ssl;
listen [::]:443 ssl;
server_name app.simonsmh.cc ipv6.simonsmh.cc;
root /var/www/simonsmh; 
index index.php;
#redir to file dir, not using link
location ~ /(files|sfiles)/ {
root /var/wwwfiles/; 
}
#Disable upload&run .php files
location ~ ^/(files|sfiles)/.*\.php(\/.*)*$
{
deny all; 
}
#Fix Access-Control-Allow-Origin for glype
location / {
add_header Access-Control-Allow-Origin *;
}
location ~ .*\.php(\/.*)*$ {
set $path_info "";
fastcgi_split_path_info ^(.+\.php)(/.+)$;
fastcgi_pass unix:/run/php/php7.0-fpm.sock;
fastcgi_index index.php;
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_param SCRIPT_NAME $fastcgi_script_name;
fastcgi_param PATH_INFO $path_info;
}
location ~* ^.+\.(eot|ttf|otf|woff|svg|woff2)$ {
access_log off;
expires max;
}
error_page  310 /310.php;
error_page  401 /401.php;
error_page  403 /403.php;
error_page  404 /404.php;
error_page  502 /502.php;
}

#blog.simonsmh.cc
server {
listen 443 ssl;
listen [::]:443 ssl;
root /var/www/blog.simonsmh;
index index.php index.html index.htm;
server_name simonsmh.cc blog.simonsmh.cc;
if (!-e $request_filename) {
rewrite ^(.*)$ /index.php$1 last;
}
location ~ .*\.php(\/.*)*$ {
set $path_info "";
fastcgi_split_path_info ^(.+\.php)(/.+)$;
fastcgi_pass unix:/run/php/php7.0-fpm.sock;
fastcgi_index index.php;
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_param SCRIPT_NAME $fastcgi_script_name;
fastcgi_param PATH_INFO $path_info;
}
}

#tieba
server {
listen 443 ssl;
listen [::]:443 ssl;
root /var/www/tieba.simonsmh;
index index.php index.html index.htm;
server_name tieba.simonsmh.cc;
location ~ .*\.php(\/.*)*$ {
set $path_info "";
fastcgi_split_path_info ^(.+\.php)(/.+)$;
fastcgi_pass unix:/run/php/php7.0-fpm.sock;
fastcgi_index index.php;
include fastcgi_params;
fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
fastcgi_param SCRIPT_NAME $fastcgi_script_name;
fastcgi_param PATH_INFO $path_info;
}
}

#transmission
server {
listen 443 ssl;
listen [::]:443 ssl;
server_name bt.simonsmh.cc;
location /{
proxy_pass http://127.0.0.1:9091;
proxy_set_header Accept-Encoding "";
proxy_pass_header  X-Transmission-Session-Id;
}
}

#dist
server {
listen 80;
listen [::]:80;
server_name dist.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 443 ssl;
listen [::]:443 ssl;
server_name dist.simonsmh.cc;
root /var/wwwfiles/files/openwrt/OpenWrt-SDK-15.05.1-ar71xx-nand_gcc-4.8-linaro_uClibc-0.9.33.2.Linux-x86_64/bin/ar71xx/packages/base;
autoindex on;
autoindex_exact_size off;
autoindex_localtime on;
}

#upstream
resolver 8.8.8.8 8.8.4.4;
upstream openwrt{ 
server downloads.openwrt.org resolve;
}
upstream ubuntu{ 
server ports.ubuntu.com resolve;
}

#openwrt
server {
listen 80;
listen [::]:80;
server_name openwrt.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 443 ssl;
listen [::]:443 ssl;
server_name openwrt.simonsmh.cc;
location /{
resolver 8.8.8.8 valid=3600s;
resolver_timeout 10s;
proxy_redirect http://downloads.openwrt.org/ /;
proxy_pass http://openwrt;
proxy_set_header Accept-Encoding "";
sub_filter downloads.openwrt.org openwrt.simonsmh.cc;
}
}

#ubuntu
server {
listen 80;
listen [::]:80;
server_name ports.simonsmh.cc;
return 301 https://$server_name$request_uri;
}
server {
listen 443 ssl;
listen [::]:443 ssl;
server_name ports.simonsmh.cc;
location /{
resolver 8.8.8.8 valid=3600s;
resolver_timeout 10s;
proxy_redirect http://ports.ubuntu.com/ /;
proxy_pass http://ubuntu;
proxy_set_header Accept-Encoding "";
sub_filter ports.ubuntu.com ports.simonsmh.cc;
}
}
